<!DOCTYPE html>
<html>
<head>
    <title>CSV Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" type="text/css">
    <style>
        .map {
            height: 100vh;
            width: 100%;
        }
        .overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            background: rgba(255,255,255,0.8);
            transition: .3s ease;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            transform: translateY(100%);
        }
        .overlay.active {
            transform: translateY(0);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #4CAF50;
            color: white;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h2>CSV Map</h2>
    <input type="file" id="csvFile" name="files"/>
    <input type="text" id="addressInput" placeholder="Scrivi parte dell'indirizzo...">
    <button id="submitButton">Cerca</button>
    <div id="map" class="map"></div>
    <div id="info" class="overlay"></div>
    <table id="data-table">
        <thead>
            <tr>
                <th>Indirizzo</th>
                <th>Prezzo Base</th>
                <th>Data Vendita</th>
                <th>URL Annuncio</th>
                <th>Parsed Address</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script type="text/javascript">
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([0, 0]),
                zoom: 2
            }),
            interactions: ol.interaction.defaults.defaults({ onFocusOnly: true })
        });


        

        document.getElementById('csvFile').addEventListener('change', handleFileSelect, false);
document.getElementById('addressInput').addEventListener('keyup', function(event) {
    if (event.key === "Enter") {
        handleAddressInput(event);
    }
}, false);
document.getElementById('submitButton').addEventListener('click', function(event) {
    handleAddressInput({target: document.getElementById('addressInput')});
}, false);

var allFeatures = [];

// Load initial data from "geocoded_italia.csv"
fetch('ALL_geocoded_italia.csv')
    .then(response => response.text())
    .then(data => handleFileLoad({target: {result: data}}));

function handleFileSelect(evt) {
    var file = evt.target.files[0];
    var reader = new FileReader();
    reader.onload = handleFileLoad;
    reader.readAsText(file);
}

function handleFileLoad(evt) {
    Papa.parse(evt.target.result, {
        header: true,
        dynamicTyping: true,
        delimiter: "|",
        complete: function(results) {
            console.log(results)
            results.data.forEach(function(item) {
                if (item.coordinate) {
                    var coordParts = item.coordinate.replace(/[\(\)]/g, '').split(',').map(Number);
                    var coord = ol.proj.fromLonLat([coordParts[1], coordParts[0]]);
                    var feature = new ol.Feature(new ol.geom.Point(coord));

                    feature.setStyle(new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 7,
                            fill: new ol.style.Fill({color: 'red'}),
                            stroke: new ol.style.Stroke({color: 'white', width: 2})
                        })
                    }));

                    feature.set('indirizzo', item.indirizzo);
                    feature.set('prezzo_base', item.prezzo_base);
                    feature.set('data_vendita', item.data_vendita);
                    feature.set('url_annuncio', item.url_annuncio);
                    feature.set('parsed_address', item.parsed_address);

                    allFeatures.push(feature);
                }
            });
        }
    });
}

function handleAddressInput(event) {
    var inputAddress = event.target.value.toLowerCase();
    var coordinates = [];

    allFeatures.forEach(function(feature) {
        var parsed_address = feature.get('indirizzo').toLowerCase();
        if (parsed_address.includes(inputAddress)) {
            var vectorSource = new ol.source.Vector({
                features: [feature]
            });

            var vectorLayer = new ol.layer.Vector({
                source: vectorSource
            });

            map.addLayer(vectorLayer);
            coordinates.push(feature.getGeometry().getCoordinates());
        }
    });

    if (coordinates.length > 0) {
        var extent = ol.extent.boundingExtent(coordinates);
        map.getView().fit(extent, map.getSize());
    }
}





        map.on('click', function(evt) {
            map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                var indirizzo = feature.get('indirizzo');
                var prezzo_base = feature.get('prezzo_base');
                var data_vendita = feature.get('data_vendita');
                var url_annuncio = feature.get('url_annuncio');
                var parsed_address = feature.get('parsed_address');

                var info = "Indirizzo: " + indirizzo + "<br>Indirizzo geolocalizzato: " + parsed_address+ "<br>Prezzo Base: " + prezzo_base + "<br>Data Vendita: " + data_vendita + "<br>URL Annuncio: <a href='" + url_annuncio + "' target='_blank'>" + url_annuncio + "</a>";
                document.getElementById('info').innerHTML = info;
                document.getElementById('info').classList.add('active');
            });
        });
    </script>
</body>
</html>
